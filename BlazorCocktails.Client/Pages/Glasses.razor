@page "/glasses"
@using System.Linq
@using API.APIService
@using BlazorCocktails.Client.Shared
@inject APIClient Api
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> L
@using System.Collections.Concurrent
@using System.Threading


<PageTitle>@L["Glasses_Title"]</PageTitle>

<MudStack Spacing="2">
    @if (glasses is null)
    {
        <MudProgressLinear Indeterminate="true" Class="mb-4" />
    }
    else
    {
        <MudSelect T="string"
                   Label="@L["Glasses_Label"]"
                   Dense="true"
                   Clearable="true"
                   Placeholder="@L["Glasses_Placeholder"]"
                   Value="selectedGlass"
                   ValueChanged="OnSelectedGlassChanged"
                   Immediate="true"
                   Disabled="@isLoading">
            @foreach (var g in glasses)
            {
                <MudSelectItem Value="@g.StrGlass">@g.StrGlass</MudSelectItem>
            }
        </MudSelect>
    }

    @if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" Class="mt-2" />
    }
    else if (drinks is null)
    {
        <MudText Class="mt-4" Color="Color.Secondary">
            @L["Glasses_SelectHint"]
        </MudText>
    }
    else
    {
        @if (drinks.Count > pageSize)
        {
            <Pager TotalItems="drinks.Count" PageSize="pageSize" Radius="2" @bind-CurrentPage="page" />
        }

        <MudGrid Class="mt-2">
            @foreach (var d in PagedDrinks)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="mb-4 hover-elevate" Style="cursor:pointer"
                             @onclick="@(() => Nav.NavigateTo($"/cocktail/{d.IdDrink}?from=glasses"))">
                        <MudCardMedia Image="@d.StrDrinkThumb" Height="160" Alt="@d.StrDrink" />
                        <MudCardContent>
                            <MudText Typo="Typo.subtitle2">@d.StrDrink</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    List<GlassDTO>? glasses;
    List<CocktailItemDTO>? drinks;

    string? selectedGlass;
    bool isLoading;
    long lastRequestId = 0;
    int page = 1;
    const int pageSize = 8;

    IEnumerable<CocktailItemDTO> PagedDrinks =>
        (drinks ?? Enumerable.Empty<CocktailItemDTO>())
            .OrderBy(d => d.StrDrink)
            .Skip((page - 1) * pageSize)
            .Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Obtenemos la lista de vasos
            glasses = (await Api.Cocktails_GetGlassesAsync())?
                        .Where(x => !string.IsNullOrWhiteSpace(x.StrGlass))
                        .OrderBy(x => x.StrGlass)
                        .ToList();
            drinks = null;
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"{L["Glasses_Error_LoadGlasses"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnSelectedGlassChanged(string? glass)
    {
        selectedGlass = glass;
        page = 1;
        await LoadDrinksAsync(selectedGlass);
    }

    private async Task LoadDrinksAsync(string? glass)
    {
        var requestId = System.Threading.Interlocked.Increment(ref lastRequestId);
        isLoading = true;
        StateHasChanged();

        try
        {
            if (string.IsNullOrWhiteSpace(glass))
            {
                // Mostramos el hint
                if (requestId == lastRequestId) drinks = null;
                return;
            }

            var result = (await Api.Cocktails_GetByGlassAsync(glass))?.ToList() ?? new();
            if (requestId == lastRequestId) drinks = result;
        }
        catch (ApiException ex)
        {
            if (requestId == lastRequestId)
            {
                Snackbar.Add($"{L["Glasses_Error_LoadDrinks"]}: {ex.Message}", Severity.Error);
                drinks = new();
            }
        }
        finally
        {
            if (requestId == lastRequestId)
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }
}

@*
 Qué hacemos:
  - Listamos los **vasos** disponibles y, al seleccionar uno, cargamos los cócteles servidos en ese vaso.
  - Mostramos los resultados en tarjetas con paginación y permitimos navegar al detalle del cóctel.

 UI:
  - <MudSelect> de vasos (clearable, Immediate, placeholder y deshabilitado mientras cargamos).
  - Indicadores de carga: <MudProgressLinear> mientras llegan los vasos y <MudProgressCircular> al traer cócteles.
  - Grid de <MudCard> (imagen + nombre). Al hacer clic navegamos a /cocktail/{id}?from=glasses.
  - <Pager> cuando hay más elementos que pageSize (8).

 Flujo:
  - OnInitializedAsync(): pedimos vasos con Api.Cocktails_GetGlassesAsync(), filtramos nulos/vacíos y ordenamos alfabéticamente.
  - OnSelectedGlassChanged(): actualizamos selección, reseteamos página y llamamos a LoadDrinksAsync().
  - LoadDrinksAsync(): si no hay vaso seleccionado, dejamos drinks = null (mostramos el hint); si hay vaso, pedimos con Api.Cocktails_GetByGlassAsync().

 Concurrencia y estado:
  - lastRequestId nos ayuda a **descartar respuestas tardías** si el usuario cambia rápido de selección.
  - isLoading controla el estado visual; usamos StateHasChanged() donde corresponde.
  - PagedDrinks ordena por nombre (StrDrink) y aplica Skip/Take según la página actual.

 Localización y errores:
  - IStringLocalizer<App> (L) para textos y mensajes.
  - Mostramos Snackbar con errores localizados si fallan las llamadas.

 Notas:
  - pageSize = 8 (constante).
  - Navegamos al detalle con el query ?from=glasses para que el botón “Volver” en el detalle nos retorne a esta pantalla.
  - Dependencias: APIClient (Api), ISnackbar, NavigationManager, MudBlazor.
*@
